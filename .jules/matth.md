## 2024-05-22 - Generalized Moran's I Formula for Irregular Graphs
**Learning:** The standard simplified formula for Moran's I ($I = \frac{N}{S_0} \frac{x^T W x}{x^T x}$) assumes either row-standardized weights ($S_0=N$) OR ignores the impact of the mean ($\bar{x}$) on the cross-product term for irregular graphs. Specifically, the expansion of the numerator $\sum_{ij} w_{ij} (x_i - \bar{x})(x_j - \bar{x})$ includes terms $-\bar{x} \sum_i x_i R_i$ and $-\bar{x} \sum_j x_j C_j$ (where $R_i, C_j$ are row/col sums of $W$). If the graph has isolated nodes ($R_i=0$) or general weights ($R_i \neq 1$), these terms do not cancel out with $+S_0 \bar{x}^2$ as they do in the regular/standardized case. Neglecting them leads to bias when the mean is non-zero, making the statistic sensitive to simple shifts in data.

**Action:** When implementing spatial statistics, always use the general quadratic form expansion rather than simplified versions that rely on implicit assumptions about graph regularity or weight normalization. I updated `morans_i_all_fast` to include the full expansion: $\text{Num} = x^T W x - \bar{x}(x^T W \mathbf{1}) - \bar{x}(\mathbf{1}^T W x) + \bar{x}^2 S_0$. This ensures correctness for any weight matrix (binary, inverse-distance, etc.) and any topology (including disconnected components).

## 2024-05-23 - Cubic Interpolation for Z-Reconstruction
**Learning:** In Extended Depth of Focus (EDOF), using linear interpolation to reconstruct pixel intensities from fractional Z-depths acts as a low-pass filter, significantly attenuating contrast and peak intensity (by >10% for sharp foci). This degradation counteracts the benefits of sub-pixel depth estimation. While linear interpolation is sufficient for smooth geometric transformations, it fails to preserve the spectral characteristics of the in-focus image, which is by definition a local maximum in sharpness/intensity.

**Action:** Use Cubic (Catmull-Rom) interpolation for intensity reconstruction when sampling from a discrete stack at fractional coordinates. This preserves the high-frequency content and peak intensity of the focused features, aligning the reconstruction quality with the precision of the depth map.

## 2024-05-24 - Continuous Manifold Sampling vs Patch-Based Reconstruction in EDoF
**Learning:** Patch-based Extended Depth of Focus (EDoF) algorithms that assume piecewise-constant depth per patch inherently introduce $C^0$ discontinuities in the effective sampling surface. This zeroth-order approximation causes geometric distortions (shearing) within patches for slanted surfaces and intensity seams at boundaries, even with alpha blending. The correct mathematical model for a smooth surface is a continuous manifold $z(x,y)$. Reconstructing the image by sampling the volumetric data $V(x,y,z)$ on this manifold via bicubic interpolation eliminates blocking artifacts and preserves texture geometry consistent with the estimated depth map.

**Action:** Replace procedural patch-blending loops with explicit surface reconstruction: first upscale the discrete depth estimates to a continuous pixel-wise depth map $z(x,y)$ (e.g., via `RegularGridInterpolator`), then sample the volume $V$ at $(x, y, z(x,y))$ using high-order interpolation. This formulation is cleaner, vectorizable, and mathematically consistent with the underlying physical model of a continuous object surface.

## 2024-05-24 - Integer Overflow in Vectorized Interpolation
**Learning:** When implementing manual vectorized interpolation (e.g., cubic spline) on image data, always explicitly cast the input array to floating-point (e.g., `float32`) before performing arithmetic. Standard image data is often `uint8` or `uint16`. Operations like `p2 - p0` where `p0 > p2` will wrap around (underflow) in unsigned integer arithmetic, producing large erroneous values. This is particularly dangerous in cubic interpolation where negative coefficients (like $-p_0$) are common.

**Action:** Added explicit `.astype(np.float32)` casts in `_sample_volume_cubic` when gathering pixel neighbors.
